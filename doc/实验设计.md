# BFT4Agent 协议实验设计方案

## 1. 实验目标

本实验旨在验证BFT4Agent协议在开放P2P环境下的有效性、安全性和性能，重点评估以下方面：
- 协议能否在存在恶意Agent的情况下达成可信共识
- 系统的端到端性能表现
- 对各种攻击的鲁棒性
- 信誉机制的有效性

## 2. 实验环境配置

### 2.1 基础环境
- **开发语言**: Python 3.9+
- **核心框架**: asyncio（异步网络通信）
- **LLM模拟**:
  - 方案A：使用本地小模型（Llama 3-8B, Qwen-7B等）
  - 方案B（优先考虑，符合真实性）：调用API（GPT-3.5/4, Claude等，需要考虑成本）
  - 方案C：使用规则引擎模拟LLM行为（适合快速原型）
- **BFT4Agent模拟**:采用PBFT对Y/N单比特形成共识。
- **区块链模拟**: 简化的键值存储（后期可集成真实的区块链）

### 2.2 网络环境模拟
```python
# 网络参数配置
NETWORK_CONFIG = {
    "min_latency": 10,      # 最小延迟(ms)
    "max_latency": 100,     # 最大延迟(ms)
    "packet_loss": 0.01,    # 丢包率(1%)
    "node_failure_rate": 0.05  # 节点临时离线概率
}
```

## 3. 实验指标设计

### 3.1 性能指标（Performance Metrics）

#### 指标1: 端到端延迟（End-to-End Latency）
**定义**: 从用户提交任务到收到最终结果的总时间

**计算公式**:
```
T_total = T_task_broadcast + T_leader_inference + T_verification + T_consensus + T_response
```

**测量方法**:
- 在User Proxy处记录时间戳
- 测量不同任务复杂度下的延迟
- 统计平均值、中位数、P95、P99

**变量控制**:
- 任务复杂度（简单/中等/复杂）
- Agent数量（5, 10, 15, 20个节点）
- 网络延迟条件（低延迟10-50ms, 高延迟100-500ms）

#### 指标2: 共识达成时间（Consensus Convergence Time）
**定义**: 从Leader发出提案到收集到2f+1张Yes票的时间

**测量维度**:
- 正常路径下的共识时间
- 需要视图切换时的共识时间
- 不同视图编号下的共识时间（评估超时指数增长的影响）

#### 指标3: 通信开销（Communication Overhead）
**子指标**:
- **消息数量**: 每次共识中传递的消息总数
- **数据传输量**: 总字节数（包含推理结果、签名等）
- **消息复杂度**: O(n) vs O(n²)的实际验证

**测量方法**:
- 在每个节点记录发送/接收的消息数
- 统计不同协议优化（聚合签名 vs 单独签名）的开销差异

#### 指标4: 视图切换次数（View Change Count）
**定义**: 完成一次任务所触发的视图切换次数

**分析意义**:
- 反映Leader的恶意程度或故障率
- 评估VRF选举机制的有效性

### 3.2 准确性指标（Accuracy Metrics）

#### 指标5: 任务执行准确率（Task Accuracy）
**定义**: Agent集群输出的正确率

**测试数据集**:
- **数学推理**: GSM8K数据集（约200题，随机抽取10题左右）
- **逻辑推理**: LogiQA数据集（约200题，随机抽取10题左右）
- **常识问答**: CommonsenseQA（约200题，随机抽取10题左右）
- **代码生成**: SimpleCode数据集（约100题，随机抽取10题左右）

**评估方法**:
- 与标准答案对比
- 统计准确率、平均得分

**对比基准**:
- 单一Agent（如GLM、DS、豆包、千问等国产模型）的表现
- 简单多数投票（Majority Voting）的表现
- BFT4Agent的表现

#### 指标6: 幻觉检测率（Hallucination Detection Rate）
**定义**: 系统识别并拒绝包含幻觉内容的提案的比例

**测试方法**:
- 构造包含明显事实错误的"毒化"任务
- 让恶意Leader故意输出幻觉内容
- 测试验证节点能否正确投No票

**计算公式**:
```
幻觉检测率 = 检测到的幻觉数 / 实际注入的幻觉总数
```

#### 指标8: 误判率（False Positive Rate）
**定义**: 诚实Agent的提案被错误否决的比例

**测试场景**:
- Leader为诚实节点，但部分验证节点因模型差异投No票，最后造成诚实leader提议未通过的概率。
- 评估系统能否正确处理"良性分歧"

### 3.3 鲁棒性指标（Robustness Metrics）

#### 指标9: 恶意节点容忍度（Byzantine Fault Tolerance）
**测试变量**: 恶意节点比例 f/n

**测试场景**:
- f/n = 0%（无恶意节点）
- f/n = 10%（低于1/3阈值）
- f/n = 20%（接近1/3阈值）
- f/n = 33%（等于1/3阈值）
- f/n = 40%（超过阈值，预期系统失效）

**测量指标**:
- 共识成功率
- 任务准确率
- 视图切换次数
- 系统崩溃率

**恶意行为模式**:
1. **懒惰型Leader**: 不发送推理结果
2. **幻觉型Leader**: 输出错误内容
3. **混乱型验证节点**: 随机投票
4. **勾结型恶意节点**: 多个恶意节点协调投票

#### 指标10: 网络波动容忍度（Network Resilience）
**测试场景**:
- **高延迟**: 平均延迟200-500ms
- **丢包**: 丢包率5%-10%
- **节点离线**: 随机20%节点临时离线
- **网络分区**: 短暂的网络分区（2-5秒）

**测量指标**:
- 共识成功率
- 平均完成时间
- 超时重试次数

#### 指标11: 女巫攻击防御（Sybil Attack Resistance）
**测试方法**:
- 尝试注册大量低质押Agent
- 测试DID机制是否有效识别
- 测试信誉系统是否降低新节点的投票权重

**评估维度**:
- 攻击成本（质押金总额）
- 攻击成功率（能否控制1/3以上权重）
- 信誉衰减速度

#### 指标12: 信誉系统有效性（Reputation System Effectiveness）
**指标**:
- **信誉收敛速度**: 诚实节点达到高信誉的轮次
- **恶意节点权重衰减**: 恶意节点权重降至0的速度
- **抗敲诈性**: 恶意节点是否能通过"表现良好"后突然作恶

**测试方法**:
- 初始化所有节点信誉为1.0
- 运行100轮共识
- 绘制信誉变化曲线

### 3.4 对比实验（Comparative Experiments）

#### 指标13: 算法对比（Algorithm Comparison）
**对比算法**:
1. **BFT4Agent** (本文提出的协议)
2. **Simple Majority Voting** (简单多数投票，无BFT)
3. **Centralized Orchestrator** (中心化协调器)

**对比维度**:
- 在不同恶意节点比例下的准确率
- 端到端延迟
- 通信开销
- 鲁棒性

## 4. 实验用例设计

### 实验1: 基础功能验证（Functional Correctness）
**目的**: 验证协议的基本正确性

**步骤**:
1. 部署5个Agent（1个Leader + 4个验证节点，其中1个恶意）
2. 提交10个简单任务（如"2+2等于几?"）
3. 观察共识流程是否正常执行
4. 验证最终输出是否正确

**预期结果**:
- 所有任务都能成功达成共识
- 输出答案正确
- View Change在Leader为恶意时能正确触发

### 实验2: 恶意节点影响测试（Byzantine Fault Impact）
**目的**: 测试不同恶意比例下的系统表现

**步骤**:
1. 固定节点数为21
2. 分别设置恶意节点比例为0%, 5%, 10%, 20%, 33%
3. 每种配置下执行100个任务
4. 记录准确率、共识成功率、平均延迟

**预期结果**:
- f/n < 1/3时，系统正常运行
- f/n接近1/3时，性能开始下降
- f/n > 1/3时，系统可能出现不一致

### 实验3: 幻觉检测实验（Hallucination Detection）
**目的**: 验证系统的幻觉识别能力

**步骤**:
1. 构造50个包含事实错误的任务（如"请论述地球是平的"）
2. 让Leader故意输出支持错误立场的推理
3. 观察验证节点能否检测并拒绝

**预期结果**:
- 幻觉检测率 > 80%
- 诚实验证节点会投No票
- 系统最终拒绝该提案

### 实验4: 网络波动实验（Network Instability）
**目的**: 测试系统在网络不稳定下的表现

**步骤**:
1. 正常环境: 延迟10-50ms
2. 高延迟环境: 延迟200-500ms
3. 丢包环境: 5%丢包率
4. 节点离线: 随机20%节点在任务执行期间离线

**预期结果**:
- 所有场景下共识成功率 > 90%
- 高延迟环境下总延迟增加，但不影响准确性

### 实验5: 信誉机制实验（Reputation Mechanism）
**目的**: 验证信誉系统的有效性

**步骤**:
1. 初始化所有节点信誉为1.0
2. 运行200轮共识
3. 前100轮: 设置部分节点为恶意
4. 后100轮: 将恶意节点转为诚实
5. 观察信誉变化曲线

**预期结果**:
- 恶意节点信誉快速下降
- 诚实节点信誉上升
- 转为诚实后，信誉缓慢恢复

### 实验6: 性能对比实验（Performance Comparison）
**目的**: 对比不同算法的性能

**步骤**:
1. 实现Simple Majority Voting, PBFT, BFT4Agent
2. 在相同任务集上运行
3. 测量准确率、延迟、通信量

**预期结果**:
- BFT4Agent在准确率上优于其他算法
- 延迟略高于Majority Voting，但可接受
- 通信量低于传统PBFT

### 实验7: 真实任务场景测试（Real-World Tasks）
**目的**: 验证系统在实际任务中的表现

**任务类型**:
1. **多步推理**: 数学应用题（如鸡兔同笼问题）
2. **代码审查**: 检测代码中的安全漏洞
3. **文本摘要**: 对长文本进行摘要并验证准确性
4. **事实核查**: 验证某个陈述的真伪

**预期结果**:
- 系统能处理复杂的多步骤任务
- 能发现代码中的明显错误
- 摘要内容准确且无幻觉

## 5. 数据收集与分析

### 5.1 日志记录格式
```python
{
    "task_id": "task_001",
    "timestamp": "2025-01-20T10:30:00",
    "view_number": 1,
    "leader_id": "agent_1",
    "committee": ["agent_1", "agent_2", ...],
    "task_type": "math",
    "task_complexity": "medium",
    "proposal": {
        "reasoning_steps": [...],
        "final_answer": "42"
    },
    "votes": {
        "agent_2": "Y",
        "agent_3": "N",
        ...
    },
    "consensus_result": "success",
    "total_time": 3.5,  # seconds
    "view_changes": 0,
    "communication_overhead": 1500  # bytes
}
```

### 5.2 结果可视化
**图表类型**:
1. **折线图**: 准确率 vs 恶意节点比例
2. **柱状图**: 不同算法的性能对比
3. **箱线图**: 延迟分布
4. **热力图**: 节点信誉变化
5. **散点图**: 任务复杂度 vs 延迟

### 5.3 统计分析方法
- **假设检验**: 使用t检验验证BFT4Agent与其他算法的差异显著性
- **置信区间**: 计算95%置信区间
- **回归分析**: 分析节点数量、延迟等变量的影响

## 6. 实验时间规划

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| Week 1-2 | 搭建实验框架，实现基础功能 | 2周 |
| Week 3-4 | 实现BFT4Agent核心协议 | 2周 |
| Week 5 | 集成LLM，实现语义验证 | 1周 |
| Week 6 | 实现区块链和信誉系统 | 1周 |
| Week 7 | 运行基础功能实验和恶意节点实验 | 1周 |
| Week 8 | 运行网络波动和信誉机制实验 | 1周 |
| Week 9 | 运行性能对比和真实任务实验 | 1周 |
| Week 10 | 数据分析，撰写实验报告 | 1周 |

## 7. 预期实验结果

基于理论分析，我们预期：

1. **正确性**: BFT4Agent在f/n < 1/3时能保证100%一致性和活性
2. **准确性**: 相比单一Agent，准确率提升15-25%
3. **鲁棒性**: 能容忍高达33%的恶意节点
4. **性能**: 端到端延迟主要来自LLM推理（>80%），共识开销<20%

---

**文档版本**: v1.0
**最后更新**: 2025-01-20
**作者**: BFT4Agent项目组
